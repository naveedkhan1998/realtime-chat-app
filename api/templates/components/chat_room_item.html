{% load static %}

<!-- Chat Room Item -->
{% with room_id_str=room.id|stringformat:"s" %}
<a href="{% url 'htmx:chat_room' room.id %}" 
   class="w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-200 text-left relative overflow-hidden
          {% if room_id_str == active %}bg-primary/10 shadow-sm border border-primary/10{% else %}hover:bg-secondary/40 border border-transparent{% endif %}"
   hx-get="{% url 'htmx:chat_room' room.id %}"
   hx-target="#main-content"
   hx-push-url="true"
   hx-swap="innerHTML"
   {% if not room.is_group_chat and room.other_participant %}data-user-id="{{ room.other_participant.id }}"{% endif %}>
{% endwith %}
    
    <!-- Active indicator bar -->
    {% with room_id_str=room.id|stringformat:"s" %}
    {% if room_id_str == active %}
    <div class="absolute left-0 w-1 h-8 top-1/2 -translate-y-1/2 rounded-r-full bg-primary"></div>
    {% endif %}
    {% endwith %}
    
    <!-- Avatar -->
    <div class="relative flex-shrink-0">
        {% if room.is_group_chat %}
        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center border-2 border-transparent {% if room_id_str == active %}ring-2 ring-primary/20{% endif %} transition-all duration-300">
            <i data-lucide="users" class="w-5 h-5 text-white"></i>
        </div>
        {% else %}
        {% with other_user=room.other_participant %}
        {% if other_user.avatar %}
        <img src="{{ other_user.avatar.url }}" 
             alt="{{ other_user.name }}" 
             class="w-11 h-11 rounded-full object-cover border-2 transition-all duration-300
                    {% if room_id_str == active %}border-primary ring-2 ring-primary/20{% else %}border-transparent hover:border-primary/30{% endif %}">
        {% else %}
        <div class="w-11 h-11 rounded-full flex items-center justify-center border-2 transition-all duration-300
                    {% if room_id_str == active %}bg-primary text-primary-foreground border-primary{% else %}bg-secondary text-muted-foreground border-transparent{% endif %}">
            <span class="text-xs font-bold">
                {{ other_user.name|slice:":1"|upper }}
            </span>
        </div>
        {% endif %}
        <!-- Online indicator -->
        <span class="online-status absolute bottom-0 right-0 w-3 h-3 border-2 border-background rounded-full ring-1 ring-green-500/20 {% if other_user.id in online_users %}bg-green-500{% else %}bg-gray-400 hidden{% endif %}"></span>
        {% endwith %}
        {% endif %}
    </div>
    
    <!-- Content -->
    <div class="flex-1 min-w-0 ml-1">
        <div class="flex items-center justify-between mb-0.5">
            <span class="text-sm font-semibold truncate transition-colors {% if room_id_str == active %}text-primary{% else %}text-foreground{% endif %}">
                {% if room.is_group_chat %}
                    {{ room.name|default:"Group Chat" }}
                {% else %}
                    {{ room.other_participant.name }}
                {% endif %}
            </span>
            
            {% if room.unread_count > 0 %}
            <span class="px-2 py-0.5 text-[10px] font-bold text-white bg-destructive rounded-full animate-in fade-in zoom-in duration-300">
                New
            </span>
            {% endif %}
        </div>
        
        <p class="text-xs truncate transition-colors {% if room_id_str == active %}text-primary/70{% else %}text-muted-foreground opacity-80{% endif %} {% if room.unread_count > 0 %}font-medium text-foreground{% endif %}">
            {% if room.last_message %}
                {% if room.last_message.sender == request.user %}
                    <span class="opacity-60">You: </span>
                {% endif %}
                {% if room.last_message.attachment %}
                    <i data-lucide="paperclip" class="w-3 h-3 inline"></i> Sent an attachment
                {% else %}
                    {{ room.last_message.content|truncatechars:35 }}
                {% endif %}
            {% elif room.is_group_chat %}
                {{ room.participants.count }} members
            {% else %}
                Click to open chat
            {% endif %}
        </p>
    </div>
</a>
